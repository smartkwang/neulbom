<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>늘봄허브 이관 강사 지원 연수 신청</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        /* 기존 CSS 스타일은 그대로 유지 */
        body {
            font-family: 'Noto Sans KR', sans-serif;
        }
        .time-slot {
            transition: all 0.3s ease;
        }
        .time-slot:hover:not(.selected):not(.disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .time-slot.selected {
            border: 2px solid #4F46E5; /* Indigo-600 */
            background-color: #EEF2FF; /* Indigo-50 */
        }
        .time-slot.disabled {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f3f4f6; /* Tailwind gray-100 or similar */
            pointer-events: none; /* Prevent clicks on disabled slots */
        }
        .progress-bar {
            height: 0.5rem;
            border-radius: 0.25rem;
            background-color: #E5E7EB; /* Tailwind gray-200 */
        }
        .progress-fill {
            height: 100%;
            border-radius: 0.25rem;
            background-color: #4F46E5; /* Indigo-600 for progress */
            transition: width 0.5s ease-in-out; /* Animate width changes */
        }
        .shake { /* For form error indication */
            animation: shake 0.5s ease-in-out;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        .field-error { /* For input field specific errors */
            border-color: #EF4444 !important; /* Red-500 */
        }
        .hidden {
            display: none !important; /* Ensure hidden elements are truly hidden */
        }
        /* Loading Spinner for Submit Button */
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #4F46E5; /* Indigo-600 */
            border-radius: 50%;
            width: 20px; /* Adjusted size */
            height: 20px; /* Adjusted size */
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-left: 8px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- HTML 구조는 기존과 동일하게 유지 -->
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- 헤더 -->
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-indigo-700 mb-2">늘봄허브 이관 강사 지원 연수</h1>
            <p class="text-gray-600">2025년 5월 연수 신청</p>
            <div class="mt-4 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-info-circle text-yellow-500"></i>
                    </div>
                    <div class="ml-3">
                        <p class="text-sm text-yellow-700" style="text-align: left;">
                            본 연수는 시간대별 최대 20명까지 신청 가능. 참가자는 전체 연수 중 오직 하나의 시간대만 신청 가능(수정불가)<br>불참시 ☎️ 044-320-4222,4227로 연락    
                        </p>
                    </div>
                </div>
            </div>
        </header>

        <!-- 메인 폼 -->
        <main class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <form id="registrationForm">
                <!-- 날짜 및 시간 선택 섹션 (기존 HTML 구조 유지) -->
                <section class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">1. 날짜 및 시간 선택</h2>
                    
                    <div class="mb-6">
                        <div class="flex border-b border-gray-200">
                            <button type="button" class="date-tab flex-1 py-3 px-4 text-center font-medium border-b-2 border-indigo-500 text-indigo-600" data-date="2025-05-22">5월 22일 (목)</button>
                            <button type="button" class="date-tab flex-1 py-3 px-4 text-center font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-date="2025-05-23">5월 23일 (금)</button>
                            <button type="button" class="date-tab flex-1 py-3 px-4 text-center font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300" data-date="2025-05-30">5월 30일 (금)</button>
                        </div>
                    </div>

                    <div>
                        <!-- 5월 22일 시간대 (기존 HTML 구조 유지) -->
                        <div class="date-slots" id="slots-2025-05-22">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-22" data-time="09:30-10:00">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-medium">09:30 - 10:00</span>
                                        <span class="text-sm registration-status-badge py-1 px-2 rounded-full">
                                            <span class="current-registrations-text">현재 --명 신청중</span>
                                        </span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                                <!-- ... 다른 시간대 슬롯들 ... -->
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-22" data-time="10:00-10:30">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-medium">10:00 - 10:30</span>
                                        <span class="text-sm registration-status-badge py-1 px-2 rounded-full">
                                            <span class="current-registrations-text">현재 --명 신청중</span>
                                        </span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-22" data-time="10:30-11:00">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-medium">10:30 - 11:00</span>
                                        <span class="text-sm registration-status-badge py-1 px-2 rounded-full">
                                            <span class="current-registrations-text">현재 --명 신청중</span>
                                        </span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-22" data-time="11:00-11:30">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-medium">11:00 - 11:30</span>
                                        <span class="text-sm registration-status-badge py-1 px-2 rounded-full">
                                            <span class="current-registrations-text">현재 --명 신청중</span>
                                        </span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-22" data-time="11:30-12:00">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-medium">11:30 - 12:00</span>
                                        <span class="text-sm registration-status-badge py-1 px-2 rounded-full">
                                            <span class="current-registrations-text">현재 --명 신청중</span>
                                        </span>
                                    </div>
                                    <div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                            </div>
                        </div>

                        <!-- 5월 23일 시간대 (기존 HTML 구조 유지) -->
                        <div class="date-slots hidden" id="slots-2025-05-23">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                 <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-23" data-time="09:30-10:00">
                                    <div class="flex justify-between items-center mb-2"><span class="font-medium">09:30 - 10:00</span><span class="text-sm registration-status-badge py-1 px-2 rounded-full"><span class="current-registrations-text">현재 --명 신청중</span></span></div><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-23" data-time="10:00-10:30">
                                    <div class="flex justify-between items-center mb-2"><span class="font-medium">10:00 - 10:30</span><span class="text-sm registration-status-badge py-1 px-2 rounded-full"><span class="current-registrations-text">현재 --명 신청중</span></span></div><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-23" data-time="10:30-11:00">
                                    <div class="flex justify-between items-center mb-2"><span class="font-medium">10:30 - 11:00</span><span class="text-sm registration-status-badge py-1 px-2 rounded-full"><span class="current-registrations-text">현재 --명 신청중</span></span></div><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-23" data-time="11:00-11:30">
                                    <div class="flex justify-between items-center mb-2"><span class="font-medium">11:00 - 11:30</span><span class="text-sm registration-status-badge py-1 px-2 rounded-full"><span class="current-registrations-text">현재 --명 신청중</span></span></div><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-23" data-time="11:30-12:00">
                                    <div class="flex justify-between items-center mb-2"><span class="font-medium">11:30 - 12:00</span><span class="text-sm registration-status-badge py-1 px-2 rounded-full"><span class="current-registrations-text">현재 --명 신청중</span></span></div><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                            </div>
                        </div>

                        <!-- 5월 30일 시간대 (기존 HTML 구조 유지) -->
                        <div class="date-slots hidden" id="slots-2025-05-30">
                             <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-30" data-time="09:30-10:00">
                                    <div class="flex justify-between items-center mb-2"><span class="font-medium">09:30 - 10:00</span><span class="text-sm registration-status-badge py-1 px-2 rounded-full"><span class="current-registrations-text">현재 --명 신청중</span></span></div><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-30" data-time="10:00-10:30">
                                    <div class="flex justify-between items-center mb-2"><span class="font-medium">10:00 - 10:30</span><span class="text-sm registration-status-badge py-1 px-2 rounded-full"><span class="current-registrations-text">현재 --명 신청중</span></span></div><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-30" data-time="10:30-11:00">
                                    <div class="flex justify-between items-center mb-2"><span class="font-medium">10:30 - 11:00</span><span class="text-sm registration-status-badge py-1 px-2 rounded-full"><span class="current-registrations-text">현재 --명 신청중</span></span></div><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-30" data-time="11:00-11:30">
                                    <div class="flex justify-between items-center mb-2"><span class="font-medium">11:00 - 11:30</span><span class="text-sm registration-status-badge py-1 px-2 rounded-full"><span class="current-registrations-text">현재 --명 신청중</span></span></div><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                                <div class="time-slot p-4 border rounded-lg cursor-pointer" data-date="2025-05-30" data-time="11:30-12:00">
                                    <div class="flex justify-between items-center mb-2"><span class="font-medium">11:30 - 12:00</span><span class="text-sm registration-status-badge py-1 px-2 rounded-full"><span class="current-registrations-text">현재 --명 신청중</span></span></div><div class="progress-bar"><div class="progress-fill" style="width: 0%"></div></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 hidden text-red-500 text-sm" id="timeSelectionError">시간을 선택해주세요.</div>
                    <input type="hidden" id="selectedDateTime" name="selectedDateTime">
                    <input type="hidden" id="selectedDate" name="selectedDate">
                    <input type="hidden" id="selectedTime" name="selectedTime">
                </section>

                <!-- 개인정보 입력 섹션 (기존 HTML 구조 유지) -->
                <section class="mb-8">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4">2. 개인정보 입력</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700 mb-1">이름 <span class="text-red-500">*</span></label>
                            <input type="text" id="name" name="name" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="홍길동" required>
                            <div class="mt-1 hidden text-red-500 text-sm" id="nameError">이름을 입력해주세요.</div>
                        </div>
                        <div>
                            <label for="email" class="block text-sm font-medium text-gray-700 mb-1">이메일 <span class="text-red-500">*</span></label>
                            <input type="email" id="email" name="email" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="example@example.com" required>
                            <div class="mt-1 hidden text-red-500 text-sm" id="emailError">유효한 이메일 주소를 입력해주세요.</div>
                        </div>
                        <div>
                            <label for="phone" class="block text-sm font-medium text-gray-700 mb-1">연락처 <span class="text-red-500">*</span></label>
                            <input type="tel" id="phone" name="phone" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="010-1234-5678" required>
                            <div class="mt-1 hidden text-red-500 text-sm" id="phoneError">올바른 형식의 연락처를 입력해주세요. (예: 010-1234-5678)</div>
                        </div>
                    </div>
                </section>

                <!-- 개인정보 수집 동의 (기존 HTML 구조 유지) -->
                <section class="mb-8">
                    <div class="bg-gray-50 p-4 rounded-md">
                        <div class="flex items-start">
                            <div class="flex items-center h-5">
                                <input id="consent" name="consent" type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded" required>
                            </div>
                            <div class="ml-3 text-sm">
                                <label for="consent" class="font-medium text-gray-700">개인정보 수집 및 이용에 동의합니다. <span class="text-red-500">*</span></label>
                                <p class="text-gray-500 mt-1">수집된 개인정보는 연수 참여 확인 및 안내를 위해서만 사용되며, 연수 종료 후 1개월 내 파기됩니다.</p>
                            </div>
                        </div>
                        <div class="mt-1 hidden text-red-500 text-sm" id="consentError">개인정보 수집 및 이용에 동의해주세요.</div>
                    </div>
                </section>

                <!-- 제출 버튼 (기존 HTML 구조 유지) -->
                <div class="text-center">
                    <button type="submit" id="submitButton" class="bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-6 rounded-md text-lg font-medium transition duration-300 transform hover:scale-105 inline-flex items-center justify-center min-w-[120px]">
                        <span id="submitButtonText">신청하기</span>
                        <span id="loadingSpinner" class="loader hidden"></span>
                    </button>
                    <div id="formError" class="mt-4 text-red-600 text-sm hidden"></div>
                </div>
            </form>
        </main>

        <!-- 알림 모달 (기존 HTML 구조 유지) -->
        <div id="successModal" class="fixed inset-0 flex items-center justify-center z-50 hidden">
            <div class="fixed inset-0 bg-black opacity-50"></div>
            <div class="bg-white p-8 rounded-lg shadow-xl z-10 max-w-md w-full">
                <div class="text-center">
                    <i class="fas fa-check-circle text-5xl text-green-500 mb-4"></i>
                    <h3 class="text-2xl font-bold text-gray-800 mb-2">신청 완료!</h3>
                    <p class="text-gray-600 mb-6" id="successMessage"></p>
                    <div class="mt-6">
                        <button type="button" class="close-modal px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">확인</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 푸터 (기존 HTML 구조 유지) -->
        <footer class="text-center text-gray-500 text-sm mt-12">
            <p>© 2025 연수 신청 시스템. All rights reserved.</p>
        </footer>
    </div>

    <script>
        // --- Configuration ---
        // 여기에 Apps Script 웹 앱 배포 후 생성된 URL을 붙여넣으세요.
        const APPS_SCRIPT_API_URL = 'https://script.google.com/macros/s/AKfycbwo85ZBGUH0lcjBhSYPa6NwIk_LWY6e4KCCpmRAgy0_zOvCTCB1vJ7UjQK_7FEF-kArhg/exec'; 

        // --- HTML 요소 가져오기 ---
        let registrationForm, submitButton, submitButtonText, loadingSpinner, formErrorDiv,
            successModal, successMessageEl, selectedDateTimeInput, selectedDateInput, selectedTimeInput;

        let refreshIntervalId = null; 

        // --- 초기화 ---
        document.addEventListener('DOMContentLoaded', function() {
            registrationForm = document.getElementById('registrationForm');
            submitButton = document.getElementById('submitButton');
            submitButtonText = document.getElementById('submitButtonText');
            loadingSpinner = document.getElementById('loadingSpinner');
            formErrorDiv = document.getElementById('formError');
            successModal = document.getElementById('successModal');
            successMessageEl = document.getElementById('successMessage');
            selectedDateTimeInput = document.getElementById('selectedDateTime');
            selectedDateInput = document.getElementById('selectedDate');
            selectedTimeInput = document.getElementById('selectedTime');

            initializePage();
            setupEventListeners();
        });

        function initializePage() {
            fetchSlotDataAndUpdateUI(); 
            if (refreshIntervalId) clearInterval(refreshIntervalId);
            refreshIntervalId = setInterval(fetchSlotDataAndUpdateUI, 60000); 

            const firstDateTab = document.querySelector('.date-tab');
            if (firstDateTab) {
                firstDateTab.click();
            }
        }

        function setupEventListeners() {
            document.querySelectorAll('.date-tab').forEach(tab => {
                tab.addEventListener('click', handleDateTabClick);
            });
            document.querySelectorAll('.time-slot').forEach(slot => {
                slot.addEventListener('click', handleTimeSlotClick);
            });
            if (registrationForm) {
                registrationForm.addEventListener('submit', handleFormSubmit);
            }
            document.querySelectorAll('.close-modal').forEach(button => {
                button.addEventListener('click', () => {
                    if (successModal) successModal.classList.add('hidden');
                });
            });
            window.addEventListener('beforeunload', () => {
                if (refreshIntervalId) clearInterval(refreshIntervalId);
            });
        }

        // --- 서버 통신 (Fetch API 사용) ---
        async function fetchSlotDataAndUpdateUI() {
            // console.log("Fetching slot data via Fetch API...");
            if (!APPS_SCRIPT_API_URL || APPS_SCRIPT_API_URL === 'https://script.google.com/macros/s/AKfycbwo85ZBGUH0lcjBhSYPa6NwIk_LWY6e4KCCpmRAgy0_zOvCTCB1vJ7UjQK_7FEF-kArhg/exec') {
                console.error("Apps Script API URL is not configured.");
                displayFormError("API URL이 설정되지 않았습니다. 관리자에게 문의하세요.");
                return;
            }
            try {
                const response = await fetch(`${APPS_SCRIPT_API_URL}?action=getSlotData`); // GET 요청
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Network response was not ok: ${response.status} ${response.statusText}. Server detail: ${errorText}`);
                }
                const slotDataFromServer = await response.json();
                updateSlotUI(slotDataFromServer);
            } catch (error) {
                console.error("Error fetching slot data:", error);
                handleServerError(error);
            }
        }

        async function submitRegistrationData(formData) {
            // console.log("Submitting via Fetch API:", formData);
            if (!APPS_SCRIPT_API_URL || APPS_SCRIPT_API_URL === 'https://script.google.com/macros/s/AKfycbwo85ZBGUH0lcjBhSYPa6NwIk_LWY6e4KCCpmRAgy0_zOvCTCB1vJ7UjQK_7FEF-kArhg/exec') {
                console.error("Apps Script API URL is not configured.");
                displayFormError("API URL이 설정되지 않았습니다. 관리자에게 문의하세요.");
                return;
            }
            setLoadingButtonState(true);
            try {
                const response = await fetch(APPS_SCRIPT_API_URL, { // POST 요청 (doPost는 action 파라미터 없이 호출)
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData) // formData 객체를 JSON 문자열로 전송
                });

                if (!response.ok) {
                    let errorData;
                    try {
                        errorData = await response.json(); // 서버가 JSON 에러를 보냈을 경우
                    } catch (e) {
                        errorData = { message: await response.text() }; // 텍스트 에러일 경우
                    }
                    throw new Error(`Server error: ${response.status} ${response.statusText}. Message: ${errorData.message || JSON.stringify(errorData)}`);
                }
                
                const responseFromServer = await response.json();
                handleRegistrationSuccess(responseFromServer);

            } catch (error) { 
                console.error("Error submitting registration:", error);
                handleRegistrationError(error);
            } finally {
                setLoadingButtonState(false); 
            }
        }

        // --- UI 업데이트 (기존 함수와 거의 동일) ---
        function updateSlotUI(slotDataFromServer) {
            // console.log("Received slot data for UI update:", JSON.stringify(slotDataFromServer, null, 2));
            if (!slotDataFromServer) {
                console.warn("updateSlotUI: slotDataFromServer is null or undefined.");
                return;
            }
            if (slotDataFromServer.error) {
                console.error("Error from server (getSlotData):", slotDataFromServer.error);
                displayFormError("슬롯 정보를 가져오는 중 오류: " + slotDataFromServer.error);
                return;
            }
            if (!slotDataFromServer.counts || typeof slotDataFromServer.totalCapacity === 'undefined') {
                console.warn("updateSlotUI: slotDataFromServer.counts or totalCapacity is missing.");
                return;
            }

            const counts = slotDataFromServer.counts;
            const totalCapacity = slotDataFromServer.totalCapacity;

            document.querySelectorAll('.time-slot').forEach(slotElement => {
                const date = slotElement.getAttribute('data-date');
                const time = slotElement.getAttribute('data-time');
                const currentRegTextEl = slotElement.querySelector('.current-registrations-text');
                const progressFillEl = slotElement.querySelector('.progress-fill');
                const capacityBadgeEl = slotElement.querySelector('.registration-status-badge');

                if (!currentRegTextEl || !progressFillEl || !capacityBadgeEl) {
                    return;
                }

                let registeredCount = 0;
                if (counts[date] && typeof counts[date][time] !== 'undefined') {
                    registeredCount = counts[date][time];
                }

                currentRegTextEl.textContent = `현재 ${registeredCount}명 신청중`;

                const percentage = totalCapacity > 0 ? (registeredCount / totalCapacity) * 100 : 0;
                progressFillEl.style.width = `${percentage}%`;

                slotElement.classList.remove('disabled');
                capacityBadgeEl.className = 'text-sm registration-status-badge py-1 px-2 rounded-full'; 
                progressFillEl.style.backgroundColor = '#4F46E5'; 

                if (registeredCount >= totalCapacity) {
                    slotElement.classList.add('disabled');
                    progressFillEl.style.backgroundColor = '#EF4444'; 
                    capacityBadgeEl.classList.add('bg-red-100', 'text-red-800');
                    currentRegTextEl.textContent = `현재 ${registeredCount}명 신청중 - 마감`;
                } else if (registeredCount >= totalCapacity * 0.75 ) { // 예: 75% (15명) 이상이면 주황색
                    progressFillEl.style.backgroundColor = '#F59E0B'; 
                    capacityBadgeEl.classList.add('bg-yellow-100', 'text-yellow-800');
                } else { 
                    capacityBadgeEl.classList.add('bg-green-100', 'text-green-800');
                }
            });
        }

        // --- 이벤트 핸들러 (기존 함수와 동일) ---
        function handleDateTabClick(event) {
            const clickedTab = event.currentTarget;
            document.querySelectorAll('.date-tab').forEach(t => {
                t.classList.remove('border-indigo-500', 'text-indigo-600');
                t.classList.add('border-transparent', 'text-gray-500');
            });
            clickedTab.classList.remove('border-transparent', 'text-gray-500');
            clickedTab.classList.add('border-indigo-500', 'text-indigo-600');

            const dateId = clickedTab.getAttribute('data-date');
            document.querySelectorAll('.date-slots').forEach(slotGroup => {
                slotGroup.classList.add('hidden');
            });
            const targetSlots = document.getElementById(`slots-${dateId}`);
            if (targetSlots) {
                targetSlots.classList.remove('hidden');
            }
        }

        function handleTimeSlotClick(event) {
            const clickedSlot = event.currentTarget;
            if (clickedSlot.classList.contains('disabled')) return;

            document.querySelectorAll('.time-slot.selected').forEach(s => s.classList.remove('selected'));
            clickedSlot.classList.add('selected');

            const date = clickedSlot.getAttribute('data-date');
            const time = clickedSlot.getAttribute('data-time');
            if(selectedDateTimeInput) selectedDateTimeInput.value = `${date} ${time}`;
            if(selectedDateInput) selectedDateInput.value = date;
            if(selectedTimeInput) selectedTimeInput.value = time;

            const timeErrorEl = document.getElementById('timeSelectionError');
            if (timeErrorEl) timeErrorEl.classList.add('hidden');
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            clearAllErrors();

            if (!validateFormInputs()) {
                const firstError = registrationForm.querySelector('.field-error, .text-red-500:not(.hidden)');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            }

            const formData = {
                name: document.getElementById('name').value.trim(),
                email: document.getElementById('email').value.trim(),
                phone: document.getElementById('phone').value.trim(),
                date: selectedDateInput ? selectedDateInput.value : '',
                time: selectedTimeInput ? selectedTimeInput.value : ''
            };
            submitRegistrationData(formData);
        }

        // --- 서버 응답 처리 (기존 함수와 거의 동일) ---
        function handleRegistrationSuccess(responseFromServer) {
            if (responseFromServer && responseFromServer.status === 'success') {
                if (responseFromServer.latestCounts) {
                    updateSlotUI(responseFromServer.latestCounts);
                } else {
                    fetchSlotDataAndUpdateUI(); 
                }
                displaySuccessModal(
                    selectedDateInput.value, 
                    selectedTimeInput.value,
                    responseFromServer.message
                );
                resetFormFields();
            } else { 
                const errorMessage = (responseFromServer && responseFromServer.message) ? responseFromServer.message : "신청 처리 중 알 수 없는 오류가 발생했습니다.";
                displayFormError(errorMessage);
                if (responseFromServer && responseFromServer.latestCounts) {
                    updateSlotUI(responseFromServer.latestCounts);
                }
                if(registrationForm) {
                    registrationForm.classList.add('shake');
                    setTimeout(() => registrationForm.classList.remove('shake'), 500);
                }
            }
        }

        function handleRegistrationError(error) { 
            console.error("Registration Error Handler:", error);
            let errorMessage = "신청 중 오류가 발생했습니다. 네트워크 연결을 확인하거나 잠시 후 다시 시도해주세요.";
            if (error && error.message) {
                errorMessage = error.message;
            } else if (typeof error === 'string') {
                errorMessage = error;
            }
            displayFormError(errorMessage);
        }
        
        function handleServerError(error) { 
            console.error("Server Error Handler:", error);
            let errorMessage = "서버와 통신 중 오류가 발생했습니다. 페이지를 새로고침하거나 나중에 다시 시도해주세요.";
            if (error && error.message) {
                errorMessage = error.message;
            } else if (typeof error === 'string') {
                errorMessage = error;
            }
            displayFormError(errorMessage);
        }

        // --- 유효성 검사 및 오류 표시 (기존 함수와 동일) ---
        function validateFormInputs() {
            let isValid = true;
            if (!selectedDateInput.value || !selectedTimeInput.value) {
                displayFieldError('timeSelectionError', '시간을 선택해주세요.'); isValid = false;
            }
            const nameEl = document.getElementById('name');
            if (!nameEl.value.trim()) {
                displayFieldError('nameError', '이름을 입력해주세요.', nameEl); isValid = false;
            }
            const emailEl = document.getElementById('email');
            if (!emailEl.value.trim() || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailEl.value.trim())) {
                displayFieldError('emailError', '유효한 이메일 주소를 입력해주세요.', emailEl); isValid = false;
            }
            const phoneEl = document.getElementById('phone');
            if (!phoneEl.value.trim() || !/^(01[016789]{1}-?\d{3,4}-?\d{4}|0\d{1,2}-?\d{3,4}-?\d{4})$/.test(phoneEl.value.trim())) {
                displayFieldError('phoneError', '올바른 형식의 연락처를 입력해주세요. (예: 010-1234-5678)', phoneEl); isValid = false;
            }
            const consentEl = document.getElementById('consent');
            if (!consentEl.checked) {
                displayFieldError('consentError', '개인정보 수집 및 이용에 동의해주세요.'); isValid = false;
            }
            return isValid;
        }

        function displayFieldError(errorElementId, message, inputElement = null) {
            const errorEl = document.getElementById(errorElementId);
            if (errorEl) {
                errorEl.textContent = message;
                errorEl.classList.remove('hidden');
            }
            if (inputElement) inputElement.classList.add('field-error');
        }

        function clearAllErrors() {
            ['timeSelectionError', 'nameError', 'emailError', 'phoneError', 'consentError'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            document.querySelectorAll('.field-error').forEach(el => el.classList.remove('field-error'));
            if (formErrorDiv) {
                formErrorDiv.classList.add('hidden');
                formErrorDiv.textContent = '';
            }
        }

        function displayFormError(message) {
            if (formErrorDiv) {
                formErrorDiv.textContent = message;
                formErrorDiv.classList.remove('hidden');
            }
        }

        // --- UI 상태 변경 (기존 함수와 동일) ---
        function setLoadingButtonState(isLoading) {
            if (!submitButton || !submitButtonText || !loadingSpinner) return;
            if (isLoading) {
                submitButton.disabled = true;
                submitButtonText.classList.add('hidden');
                loadingSpinner.classList.remove('hidden');
            } else {
                submitButton.disabled = false;
                submitButtonText.classList.remove('hidden');
                loadingSpinner.classList.add('hidden');
            }
        }

        function displaySuccessModal(date, time, serverMessage) {
            if(!successMessageEl || !successModal) return;
            const formattedDate = formatDateForDisplay(date);
            successMessageEl.textContent = `${serverMessage} (${formattedDate}, ${time} 신청 완료)`;
            successModal.classList.remove('hidden');
        }

        // --- 유틸리티 (기존 함수와 동일) ---
        function formatDateForDisplay(dateString_YYYY_MM_DD) {
            if (!dateString_YYYY_MM_DD || !dateString_YYYY_MM_DD.includes('-')) return dateString_YYYY_MM_DD;
            try {
                const [year, month, day] = dateString_YYYY_MM_DD.split('-');
                const dateObj = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
                const dayOfWeekNames = ['일', '월', '화', '수', '목', '금', '토'];
                return `${year}년 ${month}월 ${day}일 (${dayOfWeekNames[dateObj.getDay()]})`;
            } catch (e) {
                return dateString_YYYY_MM_DD;
            }
        }

        function resetFormFields() {
            if (registrationForm) registrationForm.reset();
            if (selectedDateTimeInput) selectedDateTimeInput.value = '';
            if (selectedDateInput) selectedDateInput.value = '';
            if (selectedTimeInput) selectedTimeInput.value = '';
            document.querySelectorAll('.time-slot.selected').forEach(s => s.classList.remove('selected'));
            clearAllErrors();
        }
    </script>
</body>
</html>
